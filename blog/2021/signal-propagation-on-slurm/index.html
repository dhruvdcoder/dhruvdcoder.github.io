<!DOCTYPE html>
<html lang="">

  <!-- Head -->
  <head>
        
    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Dhruvesh Patel | Signal Propagation On Slurm</title>
    <meta name="author" content="Dhruvesh Patel" />
    <meta name="description" content="the right way to send signals to a slurm job" />
    <meta name="keywords" content="slurm, computing" />

    <!-- OpenGraph -->
    <meta property="og:site_name" content="Dhruvesh Patel" />
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Dhruvesh Patel | Signal Propagation On Slurm" />
    <meta property="og:url" content="https://dhruveshp.com/blog/2021/signal-propagation-on-slurm/" />
    <meta property="og:description" content="the right way to send signals to a slurm job" />
    <meta property="og:image" content="https://dhruveshp.com/assets/img/blog_logo.png" />
    <meta property="og:locale" content="" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Signal Propagation On Slurm" />
    <meta name="twitter:description" content="the right way to send signals to a slurm job" />
    <meta name="twitter:image" content="https://dhruveshp.com/assets/img/blog_logo.png" />
    <meta name="twitter:site" content="@_dhruveshp" />
    <meta name="twitter:creator" content="@_dhruveshp" />

    <!-- Schema.org -->
    <script type="application/ld+json">
      {
        "author":
        {
          "@type": "Person",
	  "name": "Dhruvesh Patel",
	  "image": {
	    "@type": "ImageObject",
	    "url": "/assets/img/dp.jpg",
	    "width": 1000,
	    "height": 1000
	  },
          "sameAs": ["https://scholar.google.com/citations?user=6F2CvwoAAAAJ", "https://github.com/dhruvdcoder", "https://twitter.com/_dhruveshp"],
	  "url": "https://dhruveshp.com"
        },
	"publisher": {
          "@type": "Organization",
	  "name": "The Zanylytical Scientist",
	  "url": "https://dhruveshp.com/blog",
	  "logo": "https://dhruveshp.com/assets/img/blog_logo.png"
        },
        "url": "https://dhruveshp.com/blog/2021/signal-propagation-on-slurm/",
        "@type": "Article",
        "description": "the right way to send signals to a slurm job",
        "headline": "Signal Propagation On Slurm",
        "@context": "https://schema.org"
      }
    </script>


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

    <!-- Styles -->
    
    <link rel="icon" type="image/png" href="/assets/img/icon.png"/>
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://dhruveshp.com/blog/2021/signal-propagation-on-slurm/">

    <!-- Dark Mode -->
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://dhruveshp.com/"><span class="font-weight-bold">Dhruvesh</span>   Patel</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/_pages/notes/">notes</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/">teaching</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/timeline/">timeline</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Signal Propagation On Slurm</h1>
    <p class="post-meta">August 25, 2021</p>
    <p class="post-tags">
      <a href="/blog/2021"> <i class="fas fa-calendar fa-sm"></i> 2021 </a>
        ·  
        <a href="/blog/tag/hacks">
          <i class="fas fa-hashtag fa-sm"></i> hacks</a>  
          <a href="/blog/tag/tools">
          <i class="fas fa-hashtag fa-sm"></i> tools</a>  
          
        ·  
        <a href="/blog/category/tools">
          <i class="fas fa-tag fa-sm"></i> tools</a>  
          

    </p>
  </header>

  <article class="post-content">
    

    <h2 id="issue-with-signal-propagation-to-inner-script-on-slurm">Issue with signal propagation to inner script on slurm.</h2>

<p>When one runs <code class="language-plaintext highlighter-rouge">scancel</code> or when the job reaches its time limit, slurm will send SIGTERM to the job and wait for certain amount of time before it sends the final SIGKILL. During this time between SIGTERM and SIGKILL, the job can do some cleanup/saving etc to exit gracefully. This is all good. However, when we run a python script in sbatch</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">see_signal</span><span class="p">.</span><span class="n">py</span>
<span class="o">-------------</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">start script</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
	<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Script recieved signal:</span><span class="sh">"</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SIGTERM recieved, raising SIGINT</span><span class="sh">"</span><span class="p">)</span>
		<span class="k">raise</span> <span class="nb">KeyboardInterrupt</span>

<span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">print_signal</span><span class="p">)</span>
<span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGCONT</span><span class="p">,</span> <span class="n">print_signal</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>

	<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">script started</span><span class="sh">"</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">):</span>
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">working...</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">except</span> <span class="nb">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

	<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SIGINT recieved in script. We will exit gracefully</span><span class="sh">"</span><span class="p">)</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c">#SBATCH --output=t.log</span>

python see_signal.py

</code></pre></div></div>

<p>The python script never receives the SIGTERM, but dies a painful and sudden death when the job receives the SIGKILL. Also, changing the execution of the python script to a proper job step by using <code class="language-plaintext highlighter-rouge">srun python see_signal.py</code> instead of <code class="language-plaintext highlighter-rouge">python see_signal.py</code> does not help either.</p>

<h2 id="solutions">Solutions:</h2>

<ol>
  <li>
    <p>Start the process in background and use its PID to sent the relevant signal <sup id="fnref:signal" role="doc-noteref"><a href="#fn:signal" class="footnote" rel="footnote">1</a></sup></p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c">#SBATCH --output=t.log</span>
 <span class="c">#SBATCH --signal=B:TERM@60 # tells the controller</span>
                            <span class="c"># to send SIGTERM to the job 60 secs</span>
                            <span class="c"># before its time ends to give it a</span>
                            <span class="c"># chance for better cleanup.</span>

 <span class="c"># Install trap for the signals INT and TERM to</span>
 <span class="c"># the main BATCH script here.</span>
 <span class="c"># Send SIGTERM using kill to the internal script's</span>
 <span class="c"># process and wait for it to close gracefully.</span>

 <span class="c"># Note: Most python scripts don't install handler</span>
 <span class="c"># for SIGTERM and hence might die a quick painful death</span>
 <span class="c"># on recieveing SIGTERM (kill -15).</span>
 <span class="c"># To avoid this, you can send SIGINT,</span>
 <span class="c"># i.e., KeyboardInterrupt using (kill -2).</span>
 <span class="nb">trap</span> <span class="s1">'echo signal recieved in BATCH!; kill -15 "${PID}"; wait "${PID}";'</span> SIGINT SIGTERM

 <span class="c"># Start the work in background process and get its PID</span>
 python see_signal.py &amp;

 <span class="c"># Set the PID var so that the trap can use it</span>
 <span class="nv">PID</span><span class="o">=</span><span class="s2">"</span><span class="nv">$!</span><span class="s2">"</span>
 <span class="nb">wait</span> <span class="s2">"</span><span class="k">${</span><span class="nv">PID</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div>    </div>

    <p>If you cancel the job manually, make sure that you specify the signal as TERM like so <code class="language-plaintext highlighter-rouge">scancel --signal=TERM &lt;jobid&gt;</code>.</p>
  </li>
  <li>
    <p>If you only have one jobstep, a much cleaner solution is to  use <code class="language-plaintext highlighter-rouge">exec</code> to start that step in the main BATCH process (solution courtesy Michael Boratko.)</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c">#SBATCH --output=t.log</span>
 <span class="c">#SBATCH --signal=B:TERM@60 # tells the controller</span>
                            <span class="c"># to send SIGTERM to the job 60 secs</span>
                            <span class="c"># before its time ends to give it a</span>
                            <span class="c"># chance for better cleanup.</span>


 <span class="nb">exec </span>python see_signal.py

</code></pre></div>    </div>
  </li>
  <li>
    <p>By default all the signals to a job are only sent to main BATCH script. If the job-steps inside this script use <code class="language-plaintext highlighter-rouge">srun</code>, then the signals are propagated to the job-steps. However, if the main BATCH script does not handle the signal, it will not wait for the job-steps to handle the propagated signals. Hence, ultimately, the job-steps will still not get a chance to end gracefully.
 So, the recommended way for such a case is to install a trap for the signal in the main BATCH script and in it ask the job to wait for all the subprocesses/job-steps to end.<sup id="fnref:mailinglist" role="doc-noteref"><a href="#fn:mailinglist" class="footnote" rel="footnote">2</a></sup></p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c">#SBATCH --output=t.log</span>
 <span class="c">#SBATCH --signal=B:TERM@60 # tells the controller</span>
                            <span class="c"># to send SIGTERM to the job 60 secs</span>
                            <span class="c"># before its time ends to give it a</span>
                            <span class="c"># chance for better cleanup.</span>

 <span class="c"># trap the signal to the main BATCH script here.</span>
 sig_handler<span class="o">()</span>
 <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"BATCH interrupted"</span>
  <span class="nb">wait</span> <span class="c"># wait for all children, this is important!</span>
 <span class="o">}</span>

 <span class="nb">trap</span> <span class="s1">'sig_handler'</span> SIGINT SIGTERM SIGCONT

 srun python see_signal.py
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="references">References</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:signal" role="doc-endnote">
      <p><a href="https://hpc-discourse.usc.edu/t/signalling-a-job-before-time-limit-is-reached/314" target="_blank" rel="noopener noreferrer">https://hpc-discourse.usc.edu/t/signalling-a-job-before-time-limit-is-reached/314</a> <a href="#fnref:signal" class="reversefootnote" role="doc-backlink">↩</a></p>
    </li>
    <li id="fn:mailinglist" role="doc-endnote">
      <p><a href="https://lists.schedmd.com/pipermail/slurm-users/2020-April/005237.html" target="_blank" rel="noopener noreferrer">https://lists.schedmd.com/pipermail/slurm-users/2020-April/005237.html</a> <a href="#fnref:mailinglist" class="reversefootnote" role="doc-backlink">↩</a></p>
    </li>
  </ol>
</div>

  </article>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 Dhruvesh  Patel. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.
Last updated: August 06, 2023.
      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Mansory & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/mansory.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115661902-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-115661902-2');
  </script>
  </body>
</html>

